name: 🏷️ Validate PR labels and release notes
on:
  pull_request:
    types: [opened, synchronize, reopened, labeled, unlabeled, edited]
jobs:
  get-pr-labels:
    runs-on: ubuntu-latest
    steps:
      - name: Fetch repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get the list of allowed pull request labels
        id: get-allowed_labels
        run: |
          RED='\033[0;31m'
          NC='\033[0m'
          FILE_NAME=.pull-requests-allowed-labels-list
          FILE_PATH=$PROJECT_ROOT/$FILE_NAME
          if [[ ! -f "$FILE_PATH" ]]; then
             echo -e "${RED}$FILE_NAME file doesn't exits in the root of the respository${NC}"
             exit 1
          fi 
          echo "LABELS=$(cat $FILE_PATH),chore,improvement" >> $GITHUB_OUTPUT
        env:
          PROJECT_ROOT: ${{ github.workspace }}

      - name: Get PR labels
        id: pr-labels
        uses: actions/github-script@v7
        with:
          script: |
            return context.payload.pull_request.labels.map(l => l.name).join(',');
          result-encoding: string

      - name: Validate labels and release notes
        run: |
          ALLOWED_LABELS="$ALLOWED_LABELS,chore,improvement"
          IFS=',' read -r -a ALLOWED_LABELS_ARRAY <<< "$ALLOWED_LABELS"
          IFS=',' read -r -a PR_LABELS_ARRAY <<< "$PR_LABELS"
          
          SHOULD_FAIL_JOB="false"

          RED='\033[0;31m'
          NC='\033[0m'

          # Check if PR has any labels
          if [ ${#PR_LABELS_ARRAY[@]} -eq 0 ]; then
            echo -e "${RED}Error: Pull request must have at least one label from the following list: ${ALLOWED_LABELS_ARRAY[@]}${NC}"
            exit 1
          fi
          
          # Validate labels exist in allowed list
          for LABEL in "${PR_LABELS_ARRAY[@]}"; do
            if [[ ! " ${ALLOWED_LABELS_ARRAY[@]} " =~ " ${LABEL} " ]]; then
              echo -e "${RED}Invalid label found: $LABEL${NC}"
              SHOULD_FAIL_JOB="true"
            fi
          done
          
          # Validate release notes
          for LABEL in "${ALLOWED_LABELS_ARRAY[@]}"; do
            LABEL=$(echo "$LABEL" | sed 's/^ *//g' | sed 's/ *$//g')
            if [[ "$LABEL" == "chore"  || "$LABEL" == "improvement" ]]; then
              continue
            fi
            if [[ "$PR_LABELS" == *"$LABEL"* ]]; then
              cmd="awk '/<$LABEL>.*<\/$LABEL>/'"
              FEATURE_RELEASE_NOTE="$(echo $PR_BODY | eval $cmd)"
              if [[ -z "$FEATURE_RELEASE_NOTE" ]]; then
                 echo -e "${RED}Pull requests labeled with '$LABEL' must have the release note in the pull request body in the following format '<$LABEL> {THE RELEASE NOTE}  </$LABEL>'${NC}"
                 SHOULD_FAIL_JOB="true"
              fi
            fi
          done
          
          if [[ "$SHOULD_FAIL_JOB" == "true" ]]; then
            exit 1
          fi
        env:
          PR_BODY: ${{github.event.pull_request.body}}
          PR_LABELS: ${{steps.pr-labels.outputs.labels}}
          ALLOWED_LABELS: ${{ steps.get-allowed_labels.outputs.LABELS }}
